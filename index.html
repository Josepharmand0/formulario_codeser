<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Formulario con Firma</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    canvas {
      border: 2px solid #444;
      cursor: crosshair;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      font-weight: bold;
    }
    button {
      padding: 10px 15px;
      margin-top: 10px;
    }
  </style>
</head>
<script src="main.js"></script>
<body>

  <h2>Confirmación de Lectura y Firma</h2>

  <!-- FORMULARIO -->
  <form id="formulario">
    <!-- Nombre -->
    <div class="form-group">
      <label for="nombre">Nombre completo:</label><br>
      <input type="text" id="nombre" name="nombre" required>
    </div>

    <!-- Cédula -->
    <div class="form-group">
      <label for="cedula">Cédula:</label><br>
      <input type="text" id="cedula" name="cedula" required>
    </div>

    <!-- Fecha automática -->
    <div class="form-group">
      <label for="fecha">Fecha y hora:</label><br>
      <input type="text" id="fecha" name="fecha" readonly>
    </div>

    <!-- Firma -->
    <div class="form-group">
      <label>Firma (use el mouse o el dedo):</label><br>
      <canvas id="firma" width="300" height="100"></canvas><br>
      <button type="button" onclick="borrarFirma()">Borrar Firma</button>
    </div>

    <!-- Firma en base64 (oculta) -->
    <input type="hidden" id="imagenFirma" name="imagenFirma">

    <!-- Botón de envío -->
    <button type="submit">Enviar</button>
  </form>

  <script>
    // Establece fecha y hora actual
    document.getElementById("fecha").value = new Date().toLocaleString();

    // Configuración del canvas de firma
    const canvas = document.getElementById("firma");
    const ctx = canvas.getContext("2d");
    let pintando = false;

    function iniciarFirma(e) {
      pintando = true;
      dibujar(e);
    }

    function terminarFirma() {
      pintando = false;
      ctx.beginPath();
    }

    function dibujar(e) {
      if (!pintando) return;
      const rect = canvas.getBoundingClientRect();
      ctx.lineWidth = 2;
      ctx.lineCap = "round";
      ctx.strokeStyle = "#000";
      ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    }

    // Soporte para dispositivos táctiles
    canvas.addEventListener("mousedown", iniciarFirma);
    canvas.addEventListener("mouseup", terminarFirma);
    canvas.addEventListener("mouseout", terminarFirma);
    canvas.addEventListener("mousemove", dibujar);

    canvas.addEventListener("touchstart", (e) => iniciarFirma(e.touches[0]));
    canvas.addEventListener("touchend", terminarFirma);
    canvas.addEventListener("touchmove", (e) => {
      dibujar(e.touches[0]);
      e.preventDefault();
    });

    function borrarFirma() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    // Enviar formulario usando FormData (sin JSON)
    document.getElementById("formulario").addEventListener("submit", function(e) {
      e.preventDefault();

      // Convertir firma en imagen base64
      const dataURL = canvas.toDataURL();
      document.getElementById("imagenFirma").value = dataURL;

      // Crear objeto FormData
      const formData = new FormData();
      formData.append("nombre", document.getElementById("nombre").value);
      formData.append("cedula", document.getElementById("cedula").value);
      formData.append("fecha", document.getElementById("fecha").value);
      formData.append("firma", dataURL);

      // Enviar a Google Apps Script
      fetch("https://script.google.com/macros/s/AKfycbxM2XQZgd1Si8ToUQBNZYg8jHzj4CQGbzJvcgmloBIzvYg_4n3w9rv73dGfkw9rE8M/exec", {
        method: "POST",
        body: formData
      })
      .then(res => res.text())
      .then(resp => {
        alert("✅ ¡Formulario enviado correctamente!");
        document.getElementById("formulario").reset();
        borrarFirma();
      })
      .catch(err => {
        alert("❌ Error al enviar el formulario.");
        console.error("Error:", err);
      });
    });
  </script>

</body>
</html>
