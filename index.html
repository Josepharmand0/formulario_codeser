<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Formulario con Firma</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    canvas {
      border: 2px solid #444;
      cursor: crosshair;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      font-weight: bold;
    }
    button {
      padding: 10px 15px;
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <h2>Confirmación de Lectura y Firma</h2>

  <!-- FORMULARIO -->
  <form id="formulario">
    <!-- Nombre -->
    <div class="form-group">
      <label for="nombre">Nombre completo:</label><br>
      <input type="text" id="nombre" name="nombre" required>
    </div>

    <!-- Cédula -->
    <div class="form-group">
      <label for="cedula">Cédula:</label><br>
      <input type="text" id="cedula" name="cedula" required>
    </div>

    <!-- Fecha y hora (automática) -->
    <div class="form-group">
      <label for="fecha">Fecha y hora:</label><br>
      <input type="text" id="fecha" name="fecha" readonly>
    </div>

    <!-- Firma en canvas -->
    <div class="form-group">
      <label>Firma (use el mouse o el dedo):</label><br>
      <canvas id="firma" width="300" height="100"></canvas><br>
      <button type="button" onclick="borrarFirma()">Borrar Firma</button>
    </div>

    <!-- Campo oculto para guardar la imagen de la firma -->
    <input type="hidden" id="imagenFirma" name="imagenFirma">

    <!-- Botón de enviar -->
    <button type="submit">Enviar</button>
  </form>

  <script>
    // Establecer fecha y hora actual al cargar
    document.getElementById("fecha").value = new Date().toLocaleString();

    // Variables para el canvas de firma
    const canvas = document.getElementById("firma");
    const ctx = canvas.getContext("2d");
    let pintando = false;

    // Inicia el trazo
    function iniciarFirma(e) {
      pintando = true;
      dibujar(e);
    }

    // Termina el trazo
    function terminarFirma() {
      pintando = false;
      ctx.beginPath();
    }

    // Dibuja mientras se mueve el puntero
    function dibujar(e) {
      if (!pintando) return;
      const rect = canvas.getBoundingClientRect();
      ctx.lineWidth = 2;
      ctx.lineCap = "round";
      ctx.strokeStyle = "#000";
      ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    }

    // Eventos de mouse
    canvas.addEventListener("mousedown", iniciarFirma);
    canvas.addEventListener("mouseup", terminarFirma);
    canvas.addEventListener("mouseout", terminarFirma);
    canvas.addEventListener("mousemove", dibujar);

    // Eventos táctiles para celulares
    canvas.addEventListener("touchstart", (e) => iniciarFirma(e.touches[0]));
    canvas.addEventListener("touchend", terminarFirma);
    canvas.addEventListener("touchmove", (e) => {
      dibujar(e.touches[0]);
      e.preventDefault();
    });

    // Limpia el canvas
    function borrarFirma() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    // Evento al enviar el formulario
    document.getElementById("formulario").addEventListener("submit", function(e) {
      e.preventDefault(); // Evita el envío tradicional

      // Convierte el contenido del canvas en imagen base64
      const dataURL = canvas.toDataURL();
      document.getElementById("imagenFirma").value = dataURL;

      // Prepara los datos a enviar
      const datos = {
        nombre: document.getElementById("nombre").value,
        cedula: document.getElementById("cedula").value,
        fecha: document.getElementById("fecha").value,
        firma: dataURL
      };

      // ENVÍO A GOOGLE SHEETS (USA TU URL DE GOOGLE SCRIPT AQUÍ)
      fetch("https://script.google.com/macros/s/AKfycbxM2XQZgd1Si8ToUQBNZYg8jHzj4CQGbzJvcgmloBIzvYg_4n3w9rv73dGfkw9rE8M/exec", {
        method: "POST",
        body: JSON.stringify(datos),
        headers: {
          "Content-Type": "application/json"
        }
      })
      .then(res => res.text())
      .then(resp => {
        alert("✅ ¡Formulario enviado correctamente!");
        document.getElementById("formulario").reset(); // limpia los campos
        borrarFirma(); // limpia el canvas
      })
      .catch(err => {
        alert("❌ Error al enviar el formulario.");
        console.error("Error:", err);
      });
    });
  </script>

</body>
</html>
